<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Stratio.Extensions.Configuration.Vault: Stratio.Extentions.Configuration.Vault &lt;!-- omit in toc --&gt;</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Stratio.Extensions.Configuration.Vault
   &#160;<span id="projectnumber">1.0.1</span>
   </div>
   <div id="projectbrief">Simplifying Secrets Management in .NET using Hashicorp Vault (powered by Stratio)</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_README.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Stratio.Extentions.Configuration.Vault  </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Simplifying Secrets Management in .NET using Hashicorp Vault (powered by Stratio)</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Description</h1>
<p>The Stratio Vault Library serves as a convenient layer on top of the well-established <a href="https://github.com/rajanadar/VaultSharp">VaultSharp Library</a> acting as an extension of Microsoft’s Configuration and Hosting libraries, specifically tailored for applications written in .NET. Its aim is to simplify the process of using secrets within .NET solutions by leveraging the appsettings.json file and Vault’s secret management software.</p>
<p>By utilizing the Stratio Vault Library, developers can seamlessly integrate their applications with secrets or configurations fetched from Vault without the need for extensive code modifications or manual configuration changes. In order to adopt this extensions all you need to do is call <code>.useVault()</code> from your HostBuilder, this will connect your application to Vault using vault configuration in your environment. From there you can use secrets in your appsettings files by using the placeholders defined by the library.</p>
<h1><a class="anchor" id="autotoc_md2"></a>
Table of Contents</h1>
<ul>
<li><a href="#how-it-works">How it Works</a></li>
<li><a href="#caveats">Caveats</a></li>
<li><a href="#connecting-to-vault">Connecting to Vault</a></li>
<li><a href="#placeholders">Placeholders</a><ul>
<li><a href="#vault_secret"><code>vault_secret</code></a></li>
<li><a href="#vault_dict"><code>vault_dict</code></a></li>
<li><a href="#examples">Examples</a></li>
</ul>
</li>
<li><a href="#environments">Environments</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md3"></a>
How it Works</h1>
<p>Consider the example below to guide the explanation.</p>
<p>The example Host instantiation:</p>
<div class="fragment"><div class="line"> {c#}</div>
<div class="line">var host = Host.CreateDefaultBuilder()</div>
<div class="line">    .UseEnvironment(&quot;Development&quot;)</div>
<div class="line">    .ConfigureHostConfiguration(config =&gt;</div>
<div class="line">    {</div>
<div class="line">        // ... your configurations here ...</div>
<div class="line">    })</div>
<div class="line">    .ConfigureAppConfiguration((context, config) =&gt;</div>
<div class="line">    {</div>
<div class="line">        // ... your configurations here ...</div>
<div class="line">    })</div>
<div class="line">    .ConfigureServices((host, services) =&gt;</div>
<div class="line">    {</div>
<div class="line">        // ... your configurations here ...</div>
<div class="line">    })</div>
<div class="line">    .UseVault()</div>
<div class="line">    .Build();</div>
</div><!-- fragment --><p>The example appsettings.json:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;ConnectionStrings&quot;: {</div>
<div class="line">    &quot;ServerContext&quot;: &quot;Data Source={% vault_secret mssql/backoffice:host %},{% vault_secret mssql/backoffice:port %};&quot;,</div>
<div class="line">    &quot;ClientContexts&quot;: &quot;{% vault_dict mssql/clients %}&quot;</div>
<div class="line">  }</div>
<div class="line">  &quot;Vault&quot;: {</div>
<div class="line">    ... (see below)</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p>In this example, the configuration is loaded by:</p>
<ol type="1">
<li>Adding the <code>.UseVault()</code> call to the Host construction</li>
<li>Replacing the secrets in appsettings.json with placeholders</li>
</ol>
<p>There are although some questions left unanswered:</p>
<ul>
<li>What are the caveats?</li>
<li>How does the service connect and authenticate with vault?</li>
<li><code>vault_secret</code> and <code>vault_dict</code>, what's the difference? are there other types?</li>
<li>Why is the environment relevant?</li>
</ul>
<p>Refer to the sections below for the answers.</p>
<h1><a class="anchor" id="autotoc_md4"></a>
Caveats</h1>
<p>Since the placeholders are being overriden in the <code>ConfigureAppConfiguration</code> stage, only configurations loaded in <code>ConfigureHostConfiguration</code> calls will actually be properly overriden.</p>
<p>So, in the following example, the configuration in <code>appsettings.notoverriden.json</code> will not be overriden!</p>
<div class="fragment"><div class="line"> {c#}</div>
<div class="line">var host = Host.CreateDefaultBuilder()</div>
<div class="line">    .UseEnvironment(&quot;Development&quot;)</div>
<div class="line">    .ConfigureAppConfiguration((context, config) =&gt;</div>
<div class="line">    {</div>
<div class="line">        // This configurations will not be overriden because they&#39;re being loaded</div>
<div class="line">        // in the ConfigureAppConfiguration stage.</div>
<div class="line">        config.AddJsonFile(&quot;appsettings.notoverriden.json&quot;);</div>
<div class="line">    })</div>
<div class="line">    .UseVault()</div>
<div class="line">    .Build();</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md5"></a>
Connecting to Vault</h1>
<p>The NuGet expects the following Vault configurations to be present in the appsettings.json file:</p>
<div class="fragment"><div class="line">&quot;Vault&quot;: {</div>
<div class="line">  &quot;vaultAddress&quot;: &quot;https://VAULT_ADDRESS:8200&quot;,</div>
<div class="line">  &quot;mountPoint&quot;: &quot;PATH/OF/MOUNTPOINT&quot;,</div>
<div class="line">  </div>
<div class="line">  # For authentication via AppRole</div>
<div class="line">  &quot;approleAuthName&quot;: &quot;approle&quot;,</div>
<div class="line">  &quot;roleIdPath&quot;: &quot;PATH/TO/approle.role_id&quot;,</div>
<div class="line">  &quot;secretIdPath&quot;: &quot;PATH/TO/approle.secret_id&quot;,</div>
<div class="line">  </div>
<div class="line">  # For authentication via Kubernetes Role</div>
<div class="line">  &quot;kubernetesAuthName&quot;: &quot;kubernetes&quot;,</div>
<div class="line">  &quot;kubernetesSaRoleName&quot;: &quot;kubernetes-role&quot;,</div>
<div class="line">  &quot;kubernetesSaTokenPath&quot;: &quot;/var/run/secrets/kubernetes.io/serviceaccount/token&quot;</div>
<div class="line">},</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md6"></a>
Placeholders</h1>
<p>Placeholders are strings in appsettings.json that look like <code>{% &lt;type&gt; &lt;args&gt; %}</code>. These placeholders are replaced by concrete values when the Host is built.</p>
<p>Refer to the sub sections bellow for a list of supported types.</p>
<h2><a class="anchor" id="autotoc_md7"></a>
vault_secret</h2>
<p>Materializes into a field from a secret in vault.</p>
<p>Expected Format: <code>{% vault_secret &lt;path/to/secret/in/vault&gt;:&lt;secret-field&gt; %}</code></p>
<h2><a class="anchor" id="autotoc_md8"></a>
vault_dict</h2>
<p>Materializes into an entire dictionary, matching the structure of the correponding secret.</p>
<p>Expected Format: <code>{% vault_dict &lt;path/to/secret/in/vault&gt; %}</code></p>
<h2><a class="anchor" id="autotoc_md9"></a>
Examples</h2>
<p>Consider the following secret in vault:</p>
<div class="fragment"><div class="line">mssql</div>
<div class="line">|</div>
<div class="line">| - backoffice</div>
<div class="line">|     Host = backoffice.localhost</div>
<div class="line">|     Port = 1433</div>
<div class="line">| - clients</div>
<div class="line">|     _default = &quot;Data Source=default.localhost,1433&quot;</div>
<div class="line">|     other = &quot;Data Source=other.localhost,1433&quot;</div>
</div><!-- fragment --><div class="fragment"><div class="line">{% vault_secret mssql/backoffice:Host %}</div>
<div class="line"> </div>
<div class="line">would map to:</div>
<div class="line"> </div>
<div class="line">backoffice.localhost</div>
</div><!-- fragment --><div class="fragment"><div class="line">{% vault_dict mssql/clients %}</div>
<div class="line"> </div>
<div class="line">would map to:</div>
<div class="line"> </div>
<div class="line">{</div>
<div class="line">  &quot;_default&quot;: &quot;Data Source=default.localhost,1433&quot;</div>
<div class="line">  &quot;other&quot;: &quot;Data Source=other.localhost,1433&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md10"></a>
Environments</h1>
<p>Depending on the Hosting environment, different secrets will be loaded.</p>
<p>This distinction is done at the <code>mount point</code> level.</p>
<p>So, if the vault your using has credentials for multiple environments, these secrets should be at different mount points within vault.</p>
<p>Bellow is an example mapping between mount points and environment types, but in the end it all depends on your Vault installation/configuration:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Environment Type   </th><th class="markdownTableHeadNone">Mount Point    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Development   </td><td class="markdownTableBodyNone">/dev/secrets    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Staging   </td><td class="markdownTableBodyNone">/uat/secrets    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Production   </td><td class="markdownTableBodyNone">/prod/secrets   </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Jul 28 2023 09:32:22 for Stratio.Extensions.Configuration.Vault by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
